name: Migrate environments

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Get deployment environments from source repo
        id: get-envs
        uses: actions/github-script@v7
        with:
          script: |
            const response = await github.rest.repos.getAllEnvironments({
              owner: 'liatrio-enterprise',
              repo: 'environment-migration-test',
            });
            console.log(response.data);

            for (const env of response.data.environments) {
              console.log(env.name);
              console.log(env.protection_rules);
              console.log(env.deployment_branch_policy);
            }

            return response.data;
      
      - name: Create PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            console.log(JSON.stringify(${{ steps.get-envs.outputs.result }}));

            const response = ${{ steps.get-envs.outputs.result }};

            for (const env of response.environments) {
              // console.log(env.name);
              // console.log(env.protection_rules);
              // console.log(env.deployment_branch_policy);

              if (env.deployment_branch_policy === null){
                github.rest.repos.createOrUpdateEnvironment({
                  owner: 'liatrio-enterprise',
                  repo: 'calvin-test',
                  environment_name: env.name,
                  deployment_branch_policy: null
                })
              } else {
                github.rest.repos.createOrUpdateEnvironment({
                  owner: 'liatrio-enterprise',
                  repo: 'calvin-test',
                  environment_name: env.name,
                  deployment_branch_policy: {
                    protected_branches: env.deployment_branch_policy.protected_branches,
                    custom_branch_policies: env.deployment_branch_policy.custom_branch_policies,
                  }
                })
              }
            }

      - name: Migrate environment secrets
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const response = ${{ steps.get-envs.outputs.result }};
      
            for (const env of response.environments) {
              const repoID = await github.rest.repos.get({
                owner: 'liatrio-enterprise',
                repo: 'environment-migration-test',
              });
              console.log(repoID.data.id);

              const secretsResponse = await github.rest.actions.listEnvironmentSecrets({
                repository_id: repoID.data.id,
                environment_name: env.name
              });

              console.log(JSON.stringify(secretsResponse));
              console.log(secretsResponse.data.secrets);
      
              for (const secret of secretsResponse.data.secrets) {
                console.log(secret.name);
                // Get the value of the secret
                const secertValue = await github.rest.actions.getEnvironmentSecret({
                  repository_id: repoID.data.id,
                  environment_name: env.name,
                  secret_name: secret.name,
                });

                console.log(secretValue.data);
      
                // Migrate the secret to the target repository
                //await github.rest.actions.createOrUpdateEnvironmentSecret({
                //  owner: 'liatrio-enterprise',
                //  repo: 'calvin-test',
                //  environment_name: env.name,
                //  secret_name: secret.name,
                  // encrypted_value: secretValue.data.encrypted_value,
                  // key_id: secretValue.data.key_id,
                //});
              }
            }       
